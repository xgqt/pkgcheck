
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pkgcheck.checks.metadata &#8212; pkgcheck master documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">pkgcheck master documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../checks.html" accesskey="U">pkgcheck.checks</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pkgcheck.checks.metadata</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pkgcheck.checks.metadata</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">difflib</span> <span class="kn">import</span> <span class="n">SequenceMatcher</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">attrgetter</span>

<span class="kn">from</span> <span class="nn">pkgcore.ebuild</span> <span class="kn">import</span> <span class="n">atom</span> <span class="k">as</span> <span class="n">atom_mod</span>
<span class="kn">from</span> <span class="nn">pkgcore.ebuild.atom</span> <span class="kn">import</span> <span class="n">atom</span> <span class="k">as</span> <span class="n">atom_cls</span>
<span class="kn">from</span> <span class="nn">pkgcore.ebuild.eapi</span> <span class="kn">import</span> <span class="n">get_eapi</span>
<span class="kn">from</span> <span class="nn">pkgcore.ebuild.misc</span> <span class="kn">import</span> <span class="n">sort_keywords</span>
<span class="kn">from</span> <span class="nn">pkgcore.fetch</span> <span class="kn">import</span> <span class="n">fetchable</span><span class="p">,</span> <span class="n">unknown_mirror</span>
<span class="kn">from</span> <span class="nn">pkgcore.package.errors</span> <span class="kn">import</span> <span class="n">MetadataException</span>
<span class="kn">from</span> <span class="nn">pkgcore.restrictions</span> <span class="kn">import</span> <span class="n">boolean</span><span class="p">,</span> <span class="n">packages</span><span class="p">,</span> <span class="n">values</span>
<span class="kn">from</span> <span class="nn">snakeoil.mappings</span> <span class="kn">import</span> <span class="n">ImmutableDict</span>
<span class="kn">from</span> <span class="nn">snakeoil.sequences</span> <span class="kn">import</span> <span class="n">iflatten_instance</span>
<span class="kn">from</span> <span class="nn">snakeoil.strings</span> <span class="kn">import</span> <span class="n">pluralism</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">addons</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">sources</span>
<span class="kn">from</span> <span class="nn">..addons</span> <span class="kn">import</span> <span class="n">UnstatedIuse</span>
<span class="kn">from</span> <span class="nn">..base</span> <span class="kn">import</span> <span class="n">LogMap</span><span class="p">,</span> <span class="n">LogReports</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Check</span>
<span class="kn">from</span> <span class="nn">.visibility</span> <span class="kn">import</span> <span class="n">FakeConfigurable</span>


<span class="k">class</span> <span class="nc">_LicenseResult</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generic license result.&quot;&quot;&quot;</span>

    <span class="n">license_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">licenses</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">licenses</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">licenses</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pluralism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">licenses</span><span class="p">)</span>
        <span class="n">licenses</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">licenses</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">license_type</span><span class="si">}</span><span class="s1"> license</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">licenses</span><span class="si">}</span><span class="s1">&#39;</span>


<div class="viewcode-block" id="UnknownLicense"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.UnknownLicense">[docs]</a><span class="k">class</span> <span class="nc">UnknownLicense</span><span class="p">(</span><span class="n">_LicenseResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;License usage with no matching license file.&quot;&quot;&quot;</span>

    <span class="n">license_type</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span></div>


<div class="viewcode-block" id="DeprecatedLicense"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.DeprecatedLicense">[docs]</a><span class="k">class</span> <span class="nc">DeprecatedLicense</span><span class="p">(</span><span class="n">_LicenseResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deprecated license usage.&quot;&quot;&quot;</span>

    <span class="n">license_type</span> <span class="o">=</span> <span class="s1">&#39;deprecated&#39;</span></div>


<div class="viewcode-block" id="MissingLicense"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.MissingLicense">[docs]</a><span class="k">class</span> <span class="nc">MissingLicense</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package has no LICENSE defined.&quot;&quot;&quot;</span>

    <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;no license defined&#39;</span></div>


<div class="viewcode-block" id="InvalidLicense"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.InvalidLicense">[docs]</a><span class="k">class</span> <span class="nc">InvalidLicense</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package&#39;s LICENSE is invalid.&quot;&quot;&quot;</span>

    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;license&#39;</span></div>


<div class="viewcode-block" id="MissingLicenseRestricts"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.MissingLicenseRestricts">[docs]</a><span class="k">class</span> <span class="nc">MissingLicenseRestricts</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Restrictive license used without matching RESTRICT.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">license_group</span><span class="p">,</span> <span class="n">license</span><span class="p">,</span> <span class="n">restrictions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">license_group</span> <span class="o">=</span> <span class="n">license_group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">license</span> <span class="o">=</span> <span class="n">license</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restrictions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">restrictions</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">restrictions</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restrictions</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">license_group</span><span class="si">}</span><span class="s1"> license </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">license</span><span class="si">!r}</span><span class="s1"> &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;requires RESTRICT=&quot;</span><span class="si">{</span><span class="n">restrictions</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="UnnecessaryLicense"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.UnnecessaryLicense">[docs]</a><span class="k">class</span> <span class="nc">UnnecessaryLicense</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;LICENSE defined for package that is license-less.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="si">!r}</span><span class="s2"> packages shouldn&#39;t define LICENSE&quot;</span></div>


<div class="viewcode-block" id="LicenseCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.LicenseCheck">[docs]</a><span class="k">class</span> <span class="nc">LicenseCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;LICENSE validity checks.&quot;&quot;&quot;</span>

    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span>
        <span class="n">InvalidLicense</span><span class="p">,</span> <span class="n">MissingLicense</span><span class="p">,</span> <span class="n">UnknownLicense</span><span class="p">,</span> <span class="n">DeprecatedLicense</span><span class="p">,</span>
        <span class="n">UnnecessaryLicense</span><span class="p">,</span> <span class="n">UnstatedIuse</span><span class="p">,</span> <span class="n">MissingLicenseRestricts</span><span class="p">,</span>
    <span class="p">])</span>

    <span class="c1"># categories for ebuilds that can lack LICENSE settings</span>
    <span class="n">unlicensed_categories</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s1">&#39;virtual&#39;</span><span class="p">,</span> <span class="s1">&#39;acct-group&#39;</span><span class="p">,</span> <span class="s1">&#39;acct-user&#39;</span><span class="p">])</span>

    <span class="n">required_addons</span> <span class="o">=</span> <span class="p">(</span><span class="n">addons</span><span class="o">.</span><span class="n">UseAddon</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">use_addon</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">target_repo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iuse_filter</span> <span class="o">=</span> <span class="n">use_addon</span><span class="o">.</span><span class="n">get_filter</span><span class="p">(</span><span class="s1">&#39;license&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deprecated</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">licenses</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DEPRECATED&#39;</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eula</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">licenses</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;EULA&#39;</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mirror_restricts</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="s1">&#39;mirror&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_required_licenses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">license_group</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">restricts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine required licenses from a given license group.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">restricts</span> <span class="k">if</span> <span class="n">restricts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">license_group</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">boolean</span><span class="o">.</span><span class="n">AndRestriction</span><span class="p">):</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required_licenses</span><span class="p">(</span><span class="n">license_group</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">boolean</span><span class="o">.</span><span class="n">OrRestriction</span><span class="p">):</span>
                <span class="n">licenses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_required_licenses</span><span class="p">(</span><span class="n">license_group</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                <span class="c1"># skip conditionals that have another option</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">licenses</span><span class="p">):</span>
                    <span class="k">yield from</span> <span class="n">licenses</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">packages</span><span class="o">.</span><span class="n">Conditional</span><span class="p">):</span>
                <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">restriction</span><span class="p">)</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required_licenses</span><span class="p">(</span><span class="n">license_group</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">node</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

<div class="viewcode-block" id="LicenseCheck.feed"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.LicenseCheck.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="c1"># check for restrictive licenses with missing RESTRICT</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">license</span><span class="p">,</span> <span class="n">restrictions</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required_licenses</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eula</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">license</span><span class="p">):</span>
                <span class="n">restricts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">vals</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">restrictions</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">negate</span><span class="p">))</span>
                <span class="n">license_restrictions</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">restrict</span><span class="o">.</span><span class="n">evaluate_depset</span><span class="p">(</span><span class="n">restricts</span><span class="p">)</span>
                <span class="n">missing_restricts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="s1">&#39;bindist&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">license_restrictions</span><span class="p">:</span>
                    <span class="n">missing_restricts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;bindist&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mirror_restricts</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">license_restrictions</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">fetchables</span><span class="p">:</span>
                        <span class="n">missing_restricts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;mirror&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">missing_restricts</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">MissingLicenseRestricts</span><span class="p">(</span>
                        <span class="s1">&#39;EULA&#39;</span><span class="p">,</span> <span class="n">license</span><span class="p">,</span> <span class="n">missing_restricts</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

        <span class="c1"># flatten license depset</span>
        <span class="n">licenses</span><span class="p">,</span> <span class="n">unstated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iuse_filter</span><span class="p">((</span><span class="nb">str</span><span class="p">,),</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">license</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">unstated</span>
        <span class="n">licenses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">licenses</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">licenses</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unlicensed_categories</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">MissingLicense</span><span class="p">(</span><span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pkg</span><span class="o">.</span><span class="n">category</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unlicensed_categories</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">UnnecessaryLicense</span><span class="p">(</span><span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">unknown</span> <span class="o">:=</span> <span class="n">licenses</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">licenses</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">UnknownLicense</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unknown</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">deprecated</span> <span class="o">:=</span> <span class="n">licenses</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">deprecated</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">DeprecatedLicense</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">deprecated</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">_UseFlagsResult</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generic USE flags result.&quot;&quot;&quot;</span>

    <span class="n">flag_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pluralism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">)))</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flag_type</span><span class="si">}</span><span class="s1"> USE flag</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">flags</span><span class="si">}</span><span class="s1">&#39;</span>


<div class="viewcode-block" id="InvalidUseFlags"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.InvalidUseFlags">[docs]</a><span class="k">class</span> <span class="nc">InvalidUseFlags</span><span class="p">(</span><span class="n">_UseFlagsResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package IUSE contains invalid USE flags.&quot;&quot;&quot;</span>

    <span class="n">flag_type</span> <span class="o">=</span> <span class="s1">&#39;invalid&#39;</span></div>


<div class="viewcode-block" id="UnknownUseFlags"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.UnknownUseFlags">[docs]</a><span class="k">class</span> <span class="nc">UnknownUseFlags</span><span class="p">(</span><span class="n">_UseFlagsResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package IUSE contains unknown USE flags.&quot;&quot;&quot;</span>

    <span class="n">flag_type</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span></div>


<div class="viewcode-block" id="BadDefaultUseFlags"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.BadDefaultUseFlags">[docs]</a><span class="k">class</span> <span class="nc">BadDefaultUseFlags</span><span class="p">(</span><span class="n">_UseFlagsResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package IUSE contains bad default USE flags.&quot;&quot;&quot;</span>

    <span class="n">flag_type</span> <span class="o">=</span> <span class="s1">&#39;bad default&#39;</span></div>


<div class="viewcode-block" id="IuseCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.IuseCheck">[docs]</a><span class="k">class</span> <span class="nc">IuseCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;IUSE validity checks.&quot;&quot;&quot;</span>

    <span class="n">required_addons</span> <span class="o">=</span> <span class="p">(</span><span class="n">addons</span><span class="o">.</span><span class="n">UseAddon</span><span class="p">,)</span>
    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">InvalidUseFlags</span><span class="p">,</span> <span class="n">UnknownUseFlags</span><span class="p">,</span> <span class="n">BadDefaultUseFlags</span><span class="p">])</span>
    <span class="n">use_expand_groups</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;cpu_flags&#39;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">use_addon</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iuse_handler</span> <span class="o">=</span> <span class="n">use_addon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_use</span> <span class="o">=</span> <span class="n">atom_mod</span><span class="o">.</span><span class="n">valid_use_flag</span><span class="o">.</span><span class="n">match</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_defaults</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="s1">&#39;-&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;+</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1">_&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_expand_groups</span><span class="p">])</span>

<div class="viewcode-block" id="IuseCheck.feed"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.IuseCheck.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">invalid</span> <span class="o">:=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">iuse_stripped</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_use</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="n">InvalidUseFlags</span><span class="p">(</span><span class="n">invalid</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">eapi</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">iuse_defaults</span> <span class="ow">and</span> <span class="p">(</span><span class="n">bad_defaults</span> <span class="o">:=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">iuse</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bad_defaults</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="n">BadDefaultUseFlags</span><span class="p">(</span><span class="n">bad_defaults</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">iuse_handler</span><span class="o">.</span><span class="n">ignore</span><span class="p">:</span>
            <span class="n">unknown</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">iuse_stripped</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iuse_handler</span><span class="o">.</span><span class="n">allowed_iuse</span><span class="p">(</span><span class="n">pkg</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">unknown</span> <span class="o">:=</span> <span class="n">unknown</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">invalid</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">UnknownUseFlags</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unknown</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">_EapiResult</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generic EAPI result.&quot;&quot;&quot;</span>

    <span class="n">_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eapi</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eapi</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">eapi</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;uses </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_type</span><span class="si">}</span><span class="s2"> EAPI </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">eapi</span><span class="si">}</span><span class="s2">&quot;</span>


<div class="viewcode-block" id="DeprecatedEapi"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.DeprecatedEapi">[docs]</a><span class="k">class</span> <span class="nc">DeprecatedEapi</span><span class="p">(</span><span class="n">_EapiResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package&#39;s EAPI is deprecated according to repo metadata.&quot;&quot;&quot;</span>

    <span class="n">_type</span> <span class="o">=</span> <span class="s1">&#39;deprecated&#39;</span></div>


<div class="viewcode-block" id="BannedEapi"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.BannedEapi">[docs]</a><span class="k">class</span> <span class="nc">BannedEapi</span><span class="p">(</span><span class="n">_EapiResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package&#39;s EAPI is banned according to repo metadata.&quot;&quot;&quot;</span>

    <span class="n">_type</span> <span class="o">=</span> <span class="s1">&#39;banned&#39;</span></div>


<div class="viewcode-block" id="StableKeywordsOnTestingEapi"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.StableKeywordsOnTestingEapi">[docs]</a><span class="k">class</span> <span class="nc">StableKeywordsOnTestingEapi</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package has stable keywords on EAPI marked as testing-only.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eapi</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eapi</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">eapi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;stable keywords (</span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span><span class="si">}</span><span class="s2">) on testing EAPI </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">eapi</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="UnsupportedEclassEapi"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.UnsupportedEclassEapi">[docs]</a><span class="k">class</span> <span class="nc">UnsupportedEclassEapi</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ebuild inherits an eclass with outdated @SUPPORTED_EAPIS.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eapi</span><span class="p">,</span> <span class="n">eclass</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eapi</span> <span class="o">=</span> <span class="n">eapi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eclass</span> <span class="o">=</span> <span class="n">eclass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">eclass</span><span class="si">}</span><span class="s2">.eclass doesn&#39;t support EAPI </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">eapi</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="EapiCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.EapiCheck">[docs]</a><span class="k">class</span> <span class="nc">EapiCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Scan for packages with banned or deprecated EAPIs.&quot;&quot;&quot;</span>

    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">DeprecatedEapi</span><span class="p">,</span> <span class="n">BannedEapi</span><span class="p">,</span> <span class="n">UnsupportedEclassEapi</span><span class="p">,</span>
                               <span class="n">StableKeywordsOnTestingEapi</span><span class="p">])</span>
    <span class="n">required_addons</span> <span class="o">=</span> <span class="p">(</span><span class="n">addons</span><span class="o">.</span><span class="n">eclass</span><span class="o">.</span><span class="n">EclassAddon</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">eclass_addon</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eclass_cache</span> <span class="o">=</span> <span class="n">eclass_addon</span><span class="o">.</span><span class="n">eclasses</span>

<div class="viewcode-block" id="EapiCheck.feed"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.EapiCheck.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="n">eapi_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">eapi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eapi_str</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">target_repo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">eapis_banned</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">BannedEapi</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">eapi</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">eapi_str</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">target_repo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">eapis_deprecated</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">DeprecatedEapi</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">eapi</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">eapi_str</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">target_repo</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">eapis_testing</span><span class="p">:</span>
            <span class="n">stable_keywords_gen</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">keywords</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">stable_keywords</span> <span class="o">:=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">stable_keywords_gen</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">StableKeywordsOnTestingEapi</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">eapi</span><span class="p">,</span> <span class="n">stable_keywords</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">eclass</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">inherit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">eclass_obj</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eclass_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">eclass</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">eclass_obj</span><span class="o">.</span><span class="n">supported_eapis</span> <span class="ow">and</span> <span class="n">eapi_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">eclass_obj</span><span class="o">.</span><span class="n">supported_eapis</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">UnsupportedEclassEapi</span><span class="p">(</span><span class="n">eapi_str</span><span class="p">,</span> <span class="n">eclass</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="InvalidEapi"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.InvalidEapi">[docs]</a><span class="k">class</span> <span class="nc">InvalidEapi</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package&#39;s EAPI is invalid.&quot;&quot;&quot;</span>

    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;eapi&#39;</span></div>


<div class="viewcode-block" id="InvalidSlot"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.InvalidSlot">[docs]</a><span class="k">class</span> <span class="nc">InvalidSlot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package&#39;s SLOT is invalid.&quot;&quot;&quot;</span>

    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;slot&#39;</span></div>


<div class="viewcode-block" id="SourcingError"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.SourcingError">[docs]</a><span class="k">class</span> <span class="nc">SourcingError</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Failed sourcing ebuild.&quot;&quot;&quot;</span>

    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span></div>


<div class="viewcode-block" id="SourcingCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.SourcingCheck">[docs]</a><span class="k">class</span> <span class="nc">SourcingCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Scan for packages with sourcing errors or invalid, sourced metadata variables.&quot;&quot;&quot;</span>

    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">SourcingError</span><span class="p">,</span> <span class="n">InvalidEapi</span><span class="p">,</span> <span class="n">InvalidSlot</span><span class="p">])</span>
    <span class="c1"># force this check to run first in its checkrunner</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span></div>


<div class="viewcode-block" id="RequiredUseDefaults"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.RequiredUseDefaults">[docs]</a><span class="k">class</span> <span class="nc">RequiredUseDefaults</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Default USE flag settings don&#39;t satisfy REQUIRED_USE.</span>

<span class="sd">    The REQUIRED_USE constraints specified in the ebuild are not satisfied</span>
<span class="sd">    by the default USE flags used in one or more profiles. This means that</span>
<span class="sd">    users on those profiles may be unable to install the package out of the box,</span>
<span class="sd">    without having to modify package.use.</span>

<span class="sd">    This warning is usually fixed via using IUSE defaults to enable one</span>
<span class="sd">    of the needed flags, modifying package.use in the most relevant profiles</span>
<span class="sd">    or modifying REQUIRED_USE.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required_use</span><span class="p">,</span> <span class="n">use</span><span class="o">=</span><span class="p">(),</span> <span class="n">keyword</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">profile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_profiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required_use</span> <span class="o">=</span> <span class="n">required_use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">use</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyword</span> <span class="o">=</span> <span class="n">keyword</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_profiles</span> <span class="o">=</span> <span class="n">num_profiles</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_profiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_profiles</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">num_profiles</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_profiles</span><span class="si">}</span><span class="s1"> total)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_profiles</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="c1"># collapsed version</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;profile: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="si">!r}{</span><span class="n">num_profiles</span><span class="si">}</span><span class="s1"> &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;failed REQUIRED_USE: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">required_use</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;keyword: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">keyword</span><span class="si">}</span><span class="s1">, profile: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="si">!r}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s2">&quot;default USE: [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use</span><span class="p">)</span><span class="si">}</span><span class="s2">] &quot;</span>
            <span class="sa">f</span><span class="s1">&#39;-- failed REQUIRED_USE: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">required_use</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="InvalidRequiredUse"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.InvalidRequiredUse">[docs]</a><span class="k">class</span> <span class="nc">InvalidRequiredUse</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package&#39;s REQUIRED_USE is invalid.&quot;&quot;&quot;</span>

    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;required_use&#39;</span></div>


<div class="viewcode-block" id="RequiredUseCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.RequiredUseCheck">[docs]</a><span class="k">class</span> <span class="nc">RequiredUseCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;REQUIRED_USE validity checks.&quot;&quot;&quot;</span>

    <span class="c1"># only run the check for EAPI 4 and above</span>
    <span class="n">_source</span> <span class="o">=</span> <span class="p">(</span><span class="n">sources</span><span class="o">.</span><span class="n">RestrictionRepoSource</span><span class="p">,</span> <span class="p">(</span>
        <span class="n">packages</span><span class="o">.</span><span class="n">PackageRestriction</span><span class="p">(</span><span class="s1">&#39;eapi&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">.</span><span class="n">GetAttrRestriction</span><span class="p">(</span>
            <span class="s1">&#39;options.has_required_use&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">.</span><span class="n">FunctionRestriction</span><span class="p">(</span><span class="nb">bool</span><span class="p">))),))</span>
    <span class="n">required_addons</span> <span class="o">=</span> <span class="p">(</span><span class="n">addons</span><span class="o">.</span><span class="n">UseAddon</span><span class="p">,</span> <span class="n">addons</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">ProfileAddon</span><span class="p">)</span>
    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">InvalidRequiredUse</span><span class="p">,</span> <span class="n">RequiredUseDefaults</span><span class="p">,</span> <span class="n">UnstatedIuse</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">use_addon</span><span class="p">,</span> <span class="n">profile_addon</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iuse_filter</span> <span class="o">=</span> <span class="n">use_addon</span><span class="o">.</span><span class="n">get_filter</span><span class="p">(</span><span class="s1">&#39;required_use&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span> <span class="o">=</span> <span class="n">profile_addon</span>

<div class="viewcode-block" id="RequiredUseCheck.feed"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.RequiredUseCheck.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="c1"># check REQUIRED_USE for invalid nodes</span>
        <span class="n">_nodes</span><span class="p">,</span> <span class="n">unstated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iuse_filter</span><span class="p">((</span><span class="nb">str</span><span class="p">,),</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">required_use</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">unstated</span>

        <span class="c1"># check both stable/unstable profiles for stable KEYWORDS and only</span>
        <span class="c1"># unstable profiles for unstable KEYWORDS</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">sorted_keywords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keyword</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;~&#39;</span><span class="p">:</span>
                <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
            <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;~&#39;</span> <span class="o">+</span> <span class="n">keyword</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">))</span>

        <span class="c1"># check USE defaults (pkg IUSE defaults + profile USE) against</span>
        <span class="c1"># REQUIRED_USE for all profiles matching a pkg&#39;s KEYWORDS</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="p">()),</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)):</span>
                <span class="c1"># skip packages masked by the profile</span>
                <span class="k">if</span> <span class="n">profile</span><span class="o">.</span><span class="n">visible</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="n">FakeConfigurable</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">required_use</span><span class="o">.</span><span class="n">evaluate_depset</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">use</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">use</span><span class="p">):</span>
                            <span class="n">failures</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">src</span><span class="o">.</span><span class="n">use</span><span class="p">,</span> <span class="n">profile</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">profile</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># report all failures with profile info in verbose mode</span>
            <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">profile_info</span> <span class="ow">in</span> <span class="n">failures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">use</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">profile_info</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">RequiredUseDefaults</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">use</span><span class="p">),</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># only report one failure per REQUIRED_USE node in regular mode</span>
            <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">profile_info</span> <span class="ow">in</span> <span class="n">failures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">num_profiles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">profile_info</span><span class="p">)</span>
                <span class="n">_use</span><span class="p">,</span> <span class="n">_keyword</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">profile_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">yield</span> <span class="n">RequiredUseDefaults</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span> <span class="n">num_profiles</span><span class="o">=</span><span class="n">num_profiles</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="UnusedLocalUse"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.UnusedLocalUse">[docs]</a><span class="k">class</span> <span class="nc">UnusedLocalUse</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">PackageResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unused local USE flag(s).&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pluralism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;unused local USE flag</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">: [ </span><span class="si">{</span><span class="n">flags</span><span class="si">}</span><span class="s1"> ]&#39;</span></div>


<div class="viewcode-block" id="MatchingGlobalUse"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.MatchingGlobalUse">[docs]</a><span class="k">class</span> <span class="nc">MatchingGlobalUse</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">PackageResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Local USE flag description matches a global USE flag.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;local USE flag matches a global: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="si">!r}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="ProbableGlobalUse"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.ProbableGlobalUse">[docs]</a><span class="k">class</span> <span class="nc">ProbableGlobalUse</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">PackageResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Style</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Local USE flag description closely matches a global USE flag.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;local USE flag closely matches a global: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="si">!r}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="ProbableUseExpand"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.ProbableUseExpand">[docs]</a><span class="k">class</span> <span class="nc">ProbableUseExpand</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">PackageResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Local USE flag that isn&#39;t overridden matches a USE_EXPAND group.</span>

<span class="sd">    The local USE flag starts with a prefix reserved to USE_EXPAND group,</span>
<span class="sd">    yet it is not a globally defined member of this group. According</span>
<span class="sd">    to the standing policy [#]_, all possible values for each USE_EXPAND</span>
<span class="sd">    must be defined and documented globally.</span>

<span class="sd">    This warning can be fixed via moving the local flag description</span>
<span class="sd">    into appropriate profiles/desc file.</span>

<span class="sd">    .. [#] https://devmanual.gentoo.org/general-concepts/use-flags/</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;USE_EXPAND group </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="si">!r}</span><span class="s2"> matches local USE flag: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="si">!r}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="UnderscoreInUseFlag"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.UnderscoreInUseFlag">[docs]</a><span class="k">class</span> <span class="nc">UnderscoreInUseFlag</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">PackageResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Style</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;USE flag uses underscore that is reserved for USE_EXPAND.</span>

<span class="sd">    The USE flag name uses underscore. However, according to PMS</span>
<span class="sd">    underscores are reserved for USE_EXPAND flags [#]_. The recommended</span>
<span class="sd">    replacement is hyphen (&#39;-&#39;).</span>

<span class="sd">    .. [#] https://projects.gentoo.org/pms/7/pms.html#x1-200003.1.4</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;USE flag </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="si">!r}</span><span class="s2"> uses reserved underscore character&quot;</span></div>


<div class="viewcode-block" id="MissingLocalUseDesc"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.MissingLocalUseDesc">[docs]</a><span class="k">class</span> <span class="nc">MissingLocalUseDesc</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">PackageResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Local USE flag(s) missing descriptions.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pluralism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;local USE flag</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1"> missing description</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">: [ </span><span class="si">{</span><span class="n">flags</span><span class="si">}</span><span class="s1"> ]&#39;</span></div>


<div class="viewcode-block" id="LocalUseCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.LocalUseCheck">[docs]</a><span class="k">class</span> <span class="nc">LocalUseCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check local USE flags in metadata.xml for various issues.&quot;&quot;&quot;</span>

    <span class="n">_source</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="n">PackageRepoSource</span>
    <span class="n">required_addons</span> <span class="o">=</span> <span class="p">(</span><span class="n">addons</span><span class="o">.</span><span class="n">UseAddon</span><span class="p">,)</span>
    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span>
        <span class="n">UnusedLocalUse</span><span class="p">,</span> <span class="n">MatchingGlobalUse</span><span class="p">,</span> <span class="n">ProbableGlobalUse</span><span class="p">,</span>
        <span class="n">ProbableUseExpand</span><span class="p">,</span> <span class="n">UnderscoreInUseFlag</span><span class="p">,</span> <span class="n">UnstatedIuse</span><span class="p">,</span>
        <span class="n">MissingLocalUseDesc</span><span class="p">,</span>
    <span class="p">])</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">use_addon</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">repo_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">target_repo</span><span class="o">.</span><span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iuse_handler</span> <span class="o">=</span> <span class="n">use_addon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_use</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">flag</span><span class="p">:</span> <span class="n">desc</span> <span class="k">for</span> <span class="n">matcher</span><span class="p">,</span> <span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span> <span class="ow">in</span> <span class="n">repo_config</span><span class="o">.</span><span class="n">use_desc</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_expand</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">repo_config</span><span class="o">.</span><span class="n">use_expand_desc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_expand</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">flag</span> <span class="k">for</span> <span class="n">flag</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">repo_config</span><span class="o">.</span><span class="n">use_expand_desc</span><span class="p">[</span><span class="n">group</span><span class="p">]}</span>

<div class="viewcode-block" id="LocalUseCheck.feed"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.LocalUseCheck.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkgs</span><span class="p">):</span>
        <span class="n">pkg</span> <span class="o">=</span> <span class="n">pkgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">local_use</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">local_use</span>
        <span class="n">missing_desc</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">flag</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">local_use</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">desc</span><span class="p">:</span>
                <span class="n">missing_desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">flag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_use</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">SequenceMatcher</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_use</span><span class="p">[</span><span class="n">flag</span><span class="p">])</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ratio</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">MatchingGlobalUse</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ratio</span> <span class="o">&gt;=</span> <span class="mf">0.75</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">ProbableGlobalUse</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">flag</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_expand</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">flag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">_&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_expand</span><span class="p">[</span><span class="n">group</span><span class="p">]:</span>
                            <span class="k">yield</span> <span class="n">ProbableUseExpand</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">group</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">UnderscoreInUseFlag</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

        <span class="n">unused</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">local_use</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
            <span class="n">unused</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">iuse_stripped</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unused</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">UnusedLocalUse</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unused</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_desc</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">MissingLocalUseDesc</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">missing_desc</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MissingSlotDep"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.MissingSlotDep">[docs]</a><span class="k">class</span> <span class="nc">MissingSlotDep</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Missing slot value in dependencies.</span>

<span class="sd">    The package dependency does not specify a slot but the target package</span>
<span class="sd">    has multiple slots. The behavior for satisfying this kind of dependency</span>
<span class="sd">    is not strictly defined, and may result in either any or the newest package</span>
<span class="sd">    slot being accepted.</span>

<span class="sd">    Please verify whether the package works with all the dependency slots.</span>
<span class="sd">    If only one slot is actually acceptable, specify it explicitly. If multiple</span>
<span class="sd">    slots are acceptable, please use either ``:=`` or explicit ``:*`` slot operator.</span>
<span class="sd">    The operators are described in detail in the devmanual [#]_.</span>

<span class="sd">    .. [#] https://devmanual.gentoo.org/general-concepts/dependencies/#slot-dependencies</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">dep_slots</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dep</span> <span class="o">=</span> <span class="n">dep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dep_slots</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dep_slots</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dep</span><span class="si">!r}</span><span class="s2"> matches more than one slot: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[ </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dep_slots</span><span class="p">)</span><span class="si">}</span><span class="s2"> ]&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MissingSlotDepCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.MissingSlotDepCheck">[docs]</a><span class="k">class</span> <span class="nc">MissingSlotDepCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check for missing slot dependencies.&quot;&quot;&quot;</span>

    <span class="c1"># only run the check for EAPI 5 and above</span>
    <span class="n">_source</span> <span class="o">=</span> <span class="p">(</span><span class="n">sources</span><span class="o">.</span><span class="n">RestrictionRepoSource</span><span class="p">,</span> <span class="p">(</span>
        <span class="n">packages</span><span class="o">.</span><span class="n">PackageRestriction</span><span class="p">(</span><span class="s1">&#39;eapi&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">.</span><span class="n">GetAttrRestriction</span><span class="p">(</span>
            <span class="s1">&#39;options.sub_slotting&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">.</span><span class="n">FunctionRestriction</span><span class="p">(</span><span class="nb">bool</span><span class="p">))),))</span>
    <span class="n">required_addons</span> <span class="o">=</span> <span class="p">(</span><span class="n">addons</span><span class="o">.</span><span class="n">UseAddon</span><span class="p">,)</span>
    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">MissingSlotDep</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">use_addon</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iuse_filter</span> <span class="o">=</span> <span class="n">use_addon</span><span class="o">.</span><span class="n">get_filter</span><span class="p">()</span>

<div class="viewcode-block" id="MissingSlotDepCheck.feed"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.MissingSlotDepCheck.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="n">rdepend</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iuse_filter</span><span class="p">((</span><span class="n">atom_cls</span><span class="p">,),</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">rdepend</span><span class="p">)</span>
        <span class="n">depend</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iuse_filter</span><span class="p">((</span><span class="n">atom_cls</span><span class="p">,),</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">depend</span><span class="p">)</span>

        <span class="c1"># skip deps that are blockers or have explicit slots/slot operators</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">rdepend</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">depend</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span>
                    <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">blocks</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">slot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">slot_operator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="n">dep_slots</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="o">.</span><span class="n">slot</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">itermatch</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">no_usedeps</span><span class="p">)}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dep_slots</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">MissingSlotDep</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dep</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dep_slots</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MissingPackageRevision"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.MissingPackageRevision">[docs]</a><span class="k">class</span> <span class="nc">MissingPackageRevision</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Missing package revision in =cat/pkg dependencies.</span>

<span class="sd">    The dependency string uses the ``=`` operator without specifying a revision.</span>
<span class="sd">    This means that only ``-r0`` of the dependency will be matched, and newer</span>
<span class="sd">    revisions of the same ebuild will not be accepted.</span>

<span class="sd">    If any revision of the package is acceptable, the ``~`` operator should be</span>
<span class="sd">    used instead of ``=``. If only the initial revision of the dependency is</span>
<span class="sd">    allowed, ``-r0`` should be appended in order to make the intent explicit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dep</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom</span> <span class="o">=</span> <span class="n">atom</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&quot;=&quot; operator used without package revision: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dep</span><span class="si">}</span><span class="s1">=&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="si">}</span><span class="s1">&quot;&#39;</span></div>


<div class="viewcode-block" id="MissingUseDepDefault"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.MissingUseDepDefault">[docs]</a><span class="k">class</span> <span class="nc">MissingUseDepDefault</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package dependencies with USE dependencies missing defaults.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">pkgs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom</span> <span class="o">=</span> <span class="n">atom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkgs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pkgs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pluralism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkgs</span><span class="p">)</span>
        <span class="n">pkgs</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkgs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="si">}</span><span class="s1">=&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="si">}</span><span class="s1">&quot;: USE flag </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="si">!r}</span><span class="s1"> missing from &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;package</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">: [ </span><span class="si">{</span><span class="n">pkgs</span><span class="si">}</span><span class="s1"> ]&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="DeprecatedDep"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.DeprecatedDep">[docs]</a><span class="k">class</span> <span class="nc">DeprecatedDep</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package dependencies matching deprecated packages flagged in profiles/package.deprecated.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ies</span> <span class="o">=</span> <span class="n">pluralism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">singular</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">plural</span><span class="o">=</span><span class="s1">&#39;ies&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="si">}</span><span class="s2">: deprecated dependenc</span><span class="si">{</span><span class="n">ies</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="BadDependency"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.BadDependency">[docs]</a><span class="k">class</span> <span class="nc">BadDependency</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package dependency is bad for some reason.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depset</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depset</span> <span class="o">=</span> <span class="n">depset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">depset</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">=&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="si">}</span><span class="s1">&quot;&#39;</span></div>


<div class="viewcode-block" id="InvalidDepend"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.InvalidDepend">[docs]</a><span class="k">class</span> <span class="nc">InvalidDepend</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package has invalid DEPEND.&quot;&quot;&quot;</span>

    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;depend&#39;</span></div>


<div class="viewcode-block" id="InvalidRdepend"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.InvalidRdepend">[docs]</a><span class="k">class</span> <span class="nc">InvalidRdepend</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package has invalid RDEPEND.&quot;&quot;&quot;</span>

    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;rdepend&#39;</span></div>


<div class="viewcode-block" id="InvalidPdepend"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.InvalidPdepend">[docs]</a><span class="k">class</span> <span class="nc">InvalidPdepend</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package has invalid PDEPEND.&quot;&quot;&quot;</span>

    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;pdepend&#39;</span></div>


<div class="viewcode-block" id="InvalidBdepend"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.InvalidBdepend">[docs]</a><span class="k">class</span> <span class="nc">InvalidBdepend</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package has invalid BDEPEND.&quot;&quot;&quot;</span>

    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;bdepend&#39;</span></div>


<div class="viewcode-block" id="InvalidIdepend"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.InvalidIdepend">[docs]</a><span class="k">class</span> <span class="nc">InvalidIdepend</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package has invalid IDEPEND.&quot;&quot;&quot;</span>

    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;idepend&#39;</span></div>


<div class="viewcode-block" id="DependencyCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.DependencyCheck">[docs]</a><span class="k">class</span> <span class="nc">DependencyCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify dependency attributes (e.g. RDEPEND).&quot;&quot;&quot;</span>

    <span class="n">required_addons</span> <span class="o">=</span> <span class="p">(</span><span class="n">addons</span><span class="o">.</span><span class="n">UseAddon</span><span class="p">,)</span>
    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span>
        <span class="n">BadDependency</span><span class="p">,</span> <span class="n">MissingPackageRevision</span><span class="p">,</span> <span class="n">MissingUseDepDefault</span><span class="p">,</span>
        <span class="n">UnstatedIuse</span><span class="p">,</span> <span class="n">DeprecatedDep</span><span class="p">,</span> <span class="n">InvalidDepend</span><span class="p">,</span> <span class="n">InvalidRdepend</span><span class="p">,</span>
        <span class="n">InvalidPdepend</span><span class="p">,</span> <span class="n">InvalidBdepend</span><span class="p">,</span> <span class="n">InvalidIdepend</span><span class="p">,</span>
    <span class="p">])</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">use_addon</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deprecated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">target_repo</span><span class="o">.</span><span class="n">deprecated</span><span class="o">.</span><span class="n">match</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iuse_filter</span> <span class="o">=</span> <span class="n">use_addon</span><span class="o">.</span><span class="n">get_filter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditional_ops</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;(+)&#39;</span><span class="p">,</span> <span class="s1">&#39;(-)&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_check_use_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">atom</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check dependencies for missing USE dep defaults.&quot;&quot;&quot;</span>
        <span class="n">stripped_use</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">use</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditional_ops</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_defaults</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">stripped_use</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;!-&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">stripped_use</span><span class="p">:</span>
            <span class="n">missing_use_deps</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">search_repo</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">no_usedeps</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">stripped_use</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">use</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">iuse_effective</span><span class="p">:</span>
                        <span class="n">missing_use_deps</span><span class="p">[</span><span class="n">use</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">versioned_atom</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">missing_use_deps</span>
        <span class="k">return</span> <span class="p">{}</span>

<div class="viewcode-block" id="DependencyCheck.feed"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.DependencyCheck.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="n">deprecated</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">eapi</span><span class="o">.</span><span class="n">dep_keys</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">deps</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">MetadataException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="sa">f</span><span class="s1">&#39;Invalid</span><span class="si">{</span><span class="n">attr</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
                <span class="k">yield</span> <span class="bp">cls</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">msg</span><span class="p">(),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">nodes</span><span class="p">,</span> <span class="n">unstated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iuse_filter</span><span class="p">(</span>
                <span class="p">(</span><span class="n">atom_cls</span><span class="p">,</span> <span class="n">boolean</span><span class="o">.</span><span class="n">OrRestriction</span><span class="p">),</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">yield from</span> <span class="n">unstated</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">boolean</span><span class="o">.</span><span class="n">OrRestriction</span><span class="p">):</span>
                    <span class="n">in_or_restriction</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">in_or_restriction</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">iflatten_instance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">atom_cls</span><span class="p">,)):</span>
                    <span class="c1"># Skip reporting blockers on deprecated packages; the primary</span>
                    <span class="c1"># purpose of deprecations is to get rid of dependencies</span>
                    <span class="c1"># holding them in the repo.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">atom</span><span class="o">.</span><span class="n">blocks</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span><span class="n">atom</span><span class="p">):</span>
                        <span class="c1"># verify all matching packages are deprecated</span>
                        <span class="n">pkgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">search_repo</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">no_usedeps</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">versioned_atom</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">):</span>
                            <span class="n">deprecated</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">in_or_restriction</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">slot_operator</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">BadDependency</span><span class="p">(</span>
                            <span class="n">attr</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="s1">&#39;= slot operator used inside || block&#39;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">eapi</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">has_use_dep_defaults</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">use</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">missing_use_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_use_deps</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">use</span><span class="p">,</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">missing_use_deps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">pkgs</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">cpvstr</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">atoms</span><span class="p">))</span>
                            <span class="k">yield</span> <span class="n">MissingUseDepDefault</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">atom</span><span class="p">),</span> <span class="n">use</span><span class="p">,</span> <span class="n">pkgs</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">atom</span><span class="o">.</span><span class="n">revision</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">MissingPackageRevision</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">atom</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
                            <span class="k">yield</span> <span class="n">BadDependency</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="s2">&quot;package blocks itself&quot;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">slot_operator</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">BadDependency</span><span class="p">(</span>
                                <span class="n">attr</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="s1">&#39;= slot operator used in blocker&#39;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">deprecated</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">DeprecatedDep</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">atoms</span><span class="p">)),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="OutdatedBlocker"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.OutdatedBlocker">[docs]</a><span class="k">class</span> <span class="nc">OutdatedBlocker</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Info</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Blocker dependency removed at least two years ago from the tree.</span>

<span class="sd">    Note that this ignores slot/subslot deps and USE deps in blocker atoms.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom</span> <span class="o">=</span> <span class="n">atom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">age</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;outdated blocker </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="si">}</span><span class="s1">=&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="si">}</span><span class="s1">&quot;: &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;last match removed </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">age</span><span class="si">}</span><span class="s1"> years ago&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NonexistentBlocker"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.NonexistentBlocker">[docs]</a><span class="k">class</span> <span class="nc">NonexistentBlocker</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;No matches for blocker dependency in repo history.</span>

<span class="sd">    For the gentoo repo this means it was either removed before the CVS -&gt; git</span>
<span class="sd">    transition (which occurred around 2015-08-08) or it never existed at all.</span>

<span class="sd">    Note that this ignores slot/subslot deps and USE deps in blocker atoms.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom</span> <span class="o">=</span> <span class="n">atom</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;nonexistent blocker </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">attr</span><span class="si">}</span><span class="s1">=&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">atom</span><span class="si">}</span><span class="s1">&quot;: &#39;</span>
            <span class="s1">&#39;no matches in repo history&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="OutdatedBlockersCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.OutdatedBlockersCheck">[docs]</a><span class="k">class</span> <span class="nc">OutdatedBlockersCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check for outdated and nonexistent blocker dependencies.&quot;&quot;&quot;</span>

    <span class="n">required_addons</span> <span class="o">=</span> <span class="p">(</span><span class="n">addons</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">GitAddon</span><span class="p">,)</span>
    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">OutdatedBlocker</span><span class="p">,</span> <span class="n">NonexistentBlocker</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">git_addon</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">existence_repo</span> <span class="o">=</span> <span class="n">git_addon</span><span class="o">.</span><span class="n">cached_repo</span><span class="p">(</span><span class="n">addons</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">GitRemovedRepo</span><span class="p">)</span>

<div class="viewcode-block" id="OutdatedBlockersCheck.feed"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.OutdatedBlockersCheck.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="n">outdated_blockers</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="n">nonexistent_blockers</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">eapi</span><span class="o">.</span><span class="n">dep_keys</span><span class="p">):</span>
            <span class="n">blockers</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">iflatten_instance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">atom_cls</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">blockers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;=*&#39;</span><span class="p">:</span>
                    <span class="n">atom_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;=</span><span class="si">{</span><span class="n">atom</span><span class="o">.</span><span class="n">cpvstr</span><span class="si">}</span><span class="s2">*&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">atom_str</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">op</span> <span class="o">+</span> <span class="n">atom</span><span class="o">.</span><span class="n">cpvstr</span>
                <span class="n">unblocked</span> <span class="o">=</span> <span class="n">atom_cls</span><span class="p">(</span><span class="n">atom_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">search_repo</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">unblocked</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">matches</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">existence_repo</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">unblocked</span><span class="p">):</span>
                        <span class="n">removal</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">time</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">)</span>
                        <span class="n">removal</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">removal</span><span class="p">)</span>
                        <span class="n">years</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">today</span> <span class="o">-</span> <span class="n">removal</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">/</span> <span class="mi">365</span>
                        <span class="k">if</span> <span class="n">years</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">outdated_blockers</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">atom</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nonexistent_blockers</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">outdated_blockers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">years</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">OutdatedBlocker</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">atom</span><span class="p">),</span> <span class="n">years</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">nonexistent_blockers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">NonexistentBlocker</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">atom</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BadKeywords"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.BadKeywords">[docs]</a><span class="k">class</span> <span class="nc">BadKeywords</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Packages using ``-*`` should use package.mask instead.&quot;&quot;&quot;</span>

    <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;use package.mask or undefined keywords instead of KEYWORDS=&quot;-*&quot;&#39;</span></div>


<div class="viewcode-block" id="UnknownKeywords"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.UnknownKeywords">[docs]</a><span class="k">class</span> <span class="nc">UnknownKeywords</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Packages using unknown KEYWORDS.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;unknown KEYWORDS: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="OverlappingKeywords"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.OverlappingKeywords">[docs]</a><span class="k">class</span> <span class="nc">OverlappingKeywords</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Style</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Packages having overlapping arch and ~arch KEYWORDS.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="n">keywords</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;overlapping KEYWORDS: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="DuplicateKeywords"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.DuplicateKeywords">[docs]</a><span class="k">class</span> <span class="nc">DuplicateKeywords</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Style</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Packages having duplicate KEYWORDS.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;duplicate KEYWORDS: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="UnsortedKeywords"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.UnsortedKeywords">[docs]</a><span class="k">class</span> <span class="nc">UnsortedKeywords</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Style</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Packages with unsorted KEYWORDS.</span>

<span class="sd">    KEYWORDS should be sorted in alphabetical order with prefix keywords (those</span>
<span class="sd">    with hyphens in them, e.g. amd64-fbsd) after regular arches and globs (e.g. ``-*``)</span>
<span class="sd">    before them.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">sorted_keywords</span><span class="o">=</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted_keywords</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sorted_keywords</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted_keywords</span><span class="p">:</span>
            <span class="c1"># verbose mode shows list of properly sorted keywords</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">unsorted KEYWORDS: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">sorted KEYWORDS: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sorted_keywords</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;unsorted KEYWORDS: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="VirtualKeywordsUpdate"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.VirtualKeywordsUpdate">[docs]</a><span class="k">class</span> <span class="nc">VirtualKeywordsUpdate</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Info</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Virtual packages with keywords that can be updated to match dependencies.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pluralism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;KEYWORDS update</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> available: </span><span class="si">{</span><span class="n">keywords</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="KeywordsCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.KeywordsCheck">[docs]</a><span class="k">class</span> <span class="nc">KeywordsCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check package keywords for sanity; empty keywords, and -* are flagged.&quot;&quot;&quot;</span>

    <span class="n">required_addons</span> <span class="o">=</span> <span class="p">(</span><span class="n">addons</span><span class="o">.</span><span class="n">UseAddon</span><span class="p">,</span> <span class="n">addons</span><span class="o">.</span><span class="n">KeywordsAddon</span><span class="p">)</span>
    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span>
        <span class="n">BadKeywords</span><span class="p">,</span> <span class="n">UnknownKeywords</span><span class="p">,</span> <span class="n">OverlappingKeywords</span><span class="p">,</span> <span class="n">DuplicateKeywords</span><span class="p">,</span>
        <span class="n">UnsortedKeywords</span><span class="p">,</span> <span class="n">VirtualKeywordsUpdate</span><span class="p">,</span>
    <span class="p">])</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">use_addon</span><span class="p">,</span> <span class="n">keywords_addon</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iuse_filter</span> <span class="o">=</span> <span class="n">use_addon</span><span class="o">.</span><span class="n">get_filter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="n">keywords_addon</span>

<div class="viewcode-block" id="KeywordsCheck.feed"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.KeywordsCheck.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">keywords</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;-*&#39;</span><span class="p">,):</span>
            <span class="k">yield</span> <span class="n">BadKeywords</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check for unknown keywords</span>
            <span class="n">unknown</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">valid</span>
            <span class="c1"># portage-only KEYWORDS are allowed in overlays</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">gentoo_repo</span><span class="p">:</span>
                <span class="n">unknown</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">portage</span>
            <span class="k">if</span> <span class="n">unknown</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">UnknownKeywords</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unknown</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

            <span class="c1"># check for overlapping keywords</span>
            <span class="n">unstable</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">keywords</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;~&#39;</span><span class="p">}</span>
            <span class="n">stable</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">keywords</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;~&#39;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">overlapping</span> <span class="o">:=</span> <span class="n">unstable</span> <span class="o">&amp;</span> <span class="n">stable</span><span class="p">:</span>
                <span class="n">keywords</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">overlapping</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;~&#39;</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">overlapping</span><span class="p">)))))</span>
                <span class="k">yield</span> <span class="n">OverlappingKeywords</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

            <span class="c1"># check for duplicate keywords</span>
            <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">duplicates</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">DuplicateKeywords</span><span class="p">(</span><span class="n">sort_keywords</span><span class="p">(</span><span class="n">duplicates</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

            <span class="c1"># check for unsorted keywords</span>
            <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">sorted_keywords</span> <span class="o">!=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">UnsortedKeywords</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">UnsortedKeywords</span><span class="p">(</span>
                        <span class="n">pkg</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span> <span class="n">sorted_keywords</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">sorted_keywords</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="s1">&#39;virtual&#39;</span><span class="p">:</span>
                <span class="n">dep_keywords</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
                <span class="n">rdepend</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iuse_filter</span><span class="p">((</span><span class="n">atom_cls</span><span class="p">,),</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">rdepend</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">rdepend</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">search_repo</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">no_usedeps</span><span class="p">):</span>
                        <span class="n">dep_keywords</span><span class="p">[</span><span class="n">dep</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keywords</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">arches</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dep_keywords</span><span class="p">:</span>
                    <span class="n">dep_keywords</span> <span class="o">=</span> <span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="n">dep_keywords</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="n">pkg_keywords</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span>
                    <span class="n">pkg_keywords</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;~</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">keywords</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;~&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">keywords</span> <span class="o">:=</span> <span class="n">dep_keywords</span> <span class="o">-</span> <span class="n">pkg_keywords</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">VirtualKeywordsUpdate</span><span class="p">(</span><span class="n">sort_keywords</span><span class="p">(</span><span class="n">keywords</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MissingUri"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.MissingUri">[docs]</a><span class="k">class</span> <span class="nc">MissingUri</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;RESTRICT=fetch isn&#39;t set, yet no full URI exists.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pluralism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">))</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;unfetchable file</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">filenames</span><span class="si">}</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="UnknownMirror"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.UnknownMirror">[docs]</a><span class="k">class</span> <span class="nc">UnknownMirror</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;URI uses an unknown mirror.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mirror</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mirror</span> <span class="o">=</span> <span class="n">mirror</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;unknown mirror </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mirror</span><span class="si">!r}</span><span class="s1"> from URI </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="si">!r}</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="BadProtocol"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.BadProtocol">[docs]</a><span class="k">class</span> <span class="nc">BadProtocol</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;URI uses an unsupported protocol.</span>

<span class="sd">    Valid protocols are currently: http, https, and ftp</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">uris</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uris</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">uris</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pluralism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uris</span><span class="p">)</span>
        <span class="n">uris</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uris</span><span class="p">))</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;bad protocol </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">!r}</span><span class="s1"> in URI</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">uris</span><span class="si">}</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="RedundantUriRename"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.RedundantUriRename">[docs]</a><span class="k">class</span> <span class="nc">RedundantUriRename</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Style</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;URI uses a redundant rename that doesn&#39;t change the filename.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span></div>


<div class="viewcode-block" id="BadFilename"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.BadFilename">[docs]</a><span class="k">class</span> <span class="nc">BadFilename</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;URI uses unspecific or poor filename(s).</span>

<span class="sd">    Archive filenames should be disambiguated using ``-&gt;`` to rename them.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pluralism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;bad filename</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">: [ </span><span class="si">{</span><span class="n">filenames</span><span class="si">}</span><span class="s1"> ]&#39;</span></div>


<div class="viewcode-block" id="TarballAvailable"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.TarballAvailable">[docs]</a><span class="k">class</span> <span class="nc">TarballAvailable</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Style</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;URI uses .zip archive when .tar* is available.</span>

<span class="sd">    Tarballs should be preferred over zip archives due to better compression</span>
<span class="sd">    and no extra unpack dependencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uris</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uris</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">uris</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pluralism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uris</span><span class="p">)</span>
        <span class="n">uris</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uris</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;zip archive</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1"> used when tarball available: [ </span><span class="si">{</span><span class="n">uris</span><span class="si">}</span><span class="s1"> ]&#39;</span></div>


<div class="viewcode-block" id="InvalidSrcUri"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.InvalidSrcUri">[docs]</a><span class="k">class</span> <span class="nc">InvalidSrcUri</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package&#39;s SRC_URI is invalid.&quot;&quot;&quot;</span>

    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;fetchables&#39;</span></div>


<div class="viewcode-block" id="SrcUriCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.SrcUriCheck">[docs]</a><span class="k">class</span> <span class="nc">SrcUriCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;SRC_URI related checks.</span>

<span class="sd">    Verify that URIs are valid, fetchable, using a supported protocol, and</span>
<span class="sd">    don&#39;t use unspecific filenames.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">required_addons</span> <span class="o">=</span> <span class="p">(</span><span class="n">addons</span><span class="o">.</span><span class="n">UseAddon</span><span class="p">,)</span>
    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span>
        <span class="n">BadFilename</span><span class="p">,</span> <span class="n">BadProtocol</span><span class="p">,</span> <span class="n">MissingUri</span><span class="p">,</span> <span class="n">InvalidSrcUri</span><span class="p">,</span>
        <span class="n">RedundantUriRename</span><span class="p">,</span> <span class="n">TarballAvailable</span><span class="p">,</span> <span class="n">UnknownMirror</span><span class="p">,</span> <span class="n">UnstatedIuse</span><span class="p">,</span>
    <span class="p">])</span>

    <span class="n">valid_protos</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span> <span class="s2">&quot;ftp&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">use_addon</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iuse_filter</span> <span class="o">=</span> <span class="n">use_addon</span><span class="o">.</span><span class="n">get_filter</span><span class="p">(</span><span class="s1">&#39;fetchables&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zip_to_tar_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;https?://(github\.com/.*?/.*?/archive/.+\.zip|&#39;</span>
            <span class="sa">r</span><span class="s1">&#39;gitlab\.com/.*?/.*?/-/archive/.+\.zip)&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="SrcUriCheck.feed"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.SrcUriCheck.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="n">lacks_uri</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c1"># duplicate entries are possible.</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">bad_filenames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">tarball_available</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">report_uris</span> <span class="o">=</span> <span class="n">LogMap</span><span class="p">(</span><span class="s1">&#39;pkgcore.log.logger.info&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">RedundantUriRename</span><span class="p">,</span> <span class="n">pkg</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">LogReports</span><span class="p">(</span><span class="n">report_uris</span><span class="p">)</span> <span class="k">as</span> <span class="n">log_reports</span><span class="p">:</span>
            <span class="n">fetchables</span><span class="p">,</span> <span class="n">unstated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iuse_filter</span><span class="p">(</span>
                <span class="p">(</span><span class="n">fetchable</span><span class="p">,),</span> <span class="n">pkg</span><span class="p">,</span>
                <span class="n">pkg</span><span class="o">.</span><span class="n">generate_fetchables</span><span class="p">(</span>
                    <span class="n">allow_missing_checksums</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_unknown_mirrors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">skip_default_mirrors</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">yield from</span> <span class="n">log_reports</span>

        <span class="k">yield from</span> <span class="n">unstated</span>
        <span class="k">for</span> <span class="n">f_inst</span><span class="p">,</span> <span class="n">restrictions</span> <span class="ow">in</span> <span class="n">fetchables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">f_inst</span><span class="o">.</span><span class="n">filename</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f_inst</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

            <span class="n">mirrors</span> <span class="o">=</span> <span class="n">f_inst</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">visit_mirrors</span><span class="p">(</span><span class="n">treat_default_as_mirror</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">unknown_mirrors</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">sub_uri</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">sub_uri</span> <span class="ow">in</span> <span class="n">mirrors</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">unknown_mirror</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">mirror</span><span class="p">,</span> <span class="n">sub_uri</span> <span class="ow">in</span> <span class="n">unknown_mirrors</span><span class="p">:</span>
                <span class="n">uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mirror</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sub_uri</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">yield</span> <span class="n">UnknownMirror</span><span class="p">(</span><span class="n">mirror</span><span class="o">.</span><span class="n">mirror_name</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

            <span class="c1"># Check for unspecific filenames of the form ${PN}.ext, ${PV}.ext,</span>
            <span class="c1"># and v${PV}.ext as well as archives named using only the raw git</span>
            <span class="c1"># commit hash.</span>
            <span class="n">PN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">PN</span><span class="p">)</span>
            <span class="n">PV</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">PV</span><span class="p">)</span>
            <span class="n">exts</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">eapi</span><span class="o">.</span><span class="n">archive_exts_regex_pattern</span>
            <span class="n">bad_filenames_re</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;^(</span><span class="si">{</span><span class="n">PN</span><span class="si">}</span><span class="s1">|v?</span><span class="si">{</span><span class="n">PV</span><span class="si">}</span><span class="s1">|[0-9a-f]</span><span class="se">{{</span><span class="s1">40</span><span class="se">}}</span><span class="s1">)</span><span class="si">{</span><span class="n">exts</span><span class="si">}</span><span class="s1">$&#39;</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">bad_filenames_re</span><span class="p">,</span> <span class="n">f_inst</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
                <span class="n">bad_filenames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f_inst</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

            <span class="n">restricts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">vals</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">restrictions</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">negate</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">f_inst</span><span class="o">.</span><span class="n">uri</span> <span class="ow">and</span> <span class="s1">&#39;fetch&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">restrict</span><span class="o">.</span><span class="n">evaluate_depset</span><span class="p">(</span><span class="n">restricts</span><span class="p">):</span>
                <span class="n">lacks_uri</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f_inst</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bad_protocols</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">f_inst</span><span class="o">.</span><span class="n">uri</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;://&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">lacks_uri</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">uri</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_protos</span><span class="p">:</span>
                        <span class="n">bad_protocols</span><span class="p">[</span><span class="n">uri</span><span class="p">[:</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">zip_to_tar_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
                        <span class="n">tarball_available</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">uris</span> <span class="ow">in</span> <span class="n">bad_protocols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">yield</span> <span class="n">BadProtocol</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">uris</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lacks_uri</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">MissingUri</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">lacks_uri</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bad_filenames</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">BadFilename</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">bad_filenames</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tarball_available</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">TarballAvailable</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">tarball_available</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BadDescription"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.BadDescription">[docs]</a><span class="k">class</span> <span class="nc">BadDescription</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Style</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package&#39;s description is bad for some reason.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">pkg_desc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_desc</span> <span class="o">=</span> <span class="n">pkg_desc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pkg_desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;DESCRIPTION=&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_desc</span><span class="si">}</span><span class="s1">&quot; &#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_desc</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pkg_desc</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="DescriptionCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.DescriptionCheck">[docs]</a><span class="k">class</span> <span class="nc">DescriptionCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DESCRIPTION checks.</span>

<span class="sd">    Check on length (&lt;=150), too short (&lt;10), or generic (lifted from eclass or</span>
<span class="sd">    just using the package&#39;s name.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">BadDescription</span><span class="p">])</span>

<div class="viewcode-block" id="DescriptionCheck.feed"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.DescriptionCheck.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">description</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;based on&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;eclass&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">BadDescription</span><span class="p">(</span><span class="s2">&quot;generic eclass defined description&quot;</span><span class="p">,</span> <span class="n">pkg_desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">pkg</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
            <span class="k">yield</span> <span class="n">BadDescription</span><span class="p">(</span><span class="s2">&quot;generic package description&quot;</span><span class="p">,</span> <span class="n">pkg_desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">desc_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">desc_len</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">BadDescription</span><span class="p">(</span><span class="s2">&quot;empty/unset&quot;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">desc_len</span> <span class="o">&gt;</span> <span class="mi">150</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">BadDescription</span><span class="p">(</span><span class="s2">&quot;over 150 chars in length&quot;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">desc_len</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">BadDescription</span><span class="p">(</span><span class="s2">&quot;under 10 chars in length&quot;</span><span class="p">,</span> <span class="n">pkg_desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BadHomepage"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.BadHomepage">[docs]</a><span class="k">class</span> <span class="nc">BadHomepage</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A package&#39;s HOMEPAGE is bad for some reason.</span>

<span class="sd">    See the HOMEPAGE ebuild variable entry in the devmanual [#]_ for more</span>
<span class="sd">    information.</span>

<span class="sd">    .. [#] https://devmanual.gentoo.org/ebuild-writing/variables/#ebuild-defined-variables</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span></div>


<div class="viewcode-block" id="HomepageCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.HomepageCheck">[docs]</a><span class="k">class</span> <span class="nc">HomepageCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;HOMEPAGE checks.&quot;&quot;&quot;</span>

    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">BadHomepage</span><span class="p">])</span>

    <span class="c1"># categories for ebuilds that should lack HOMEPAGE</span>
    <span class="n">missing_categories</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s1">&#39;virtual&#39;</span><span class="p">,</span> <span class="s1">&#39;acct-group&#39;</span><span class="p">,</span> <span class="s1">&#39;acct-user&#39;</span><span class="p">])</span>
    <span class="c1"># generic sites that shouldn&#39;t be used for HOMEPAGE</span>
    <span class="n">generic_sites</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s1">&#39;https://www.gentoo.org&#39;</span><span class="p">,</span> <span class="s1">&#39;https://gentoo.org&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="HomepageCheck.feed"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.HomepageCheck.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pkg</span><span class="o">.</span><span class="n">homepage</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing_categories</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">BadHomepage</span><span class="p">(</span><span class="s1">&#39;HOMEPAGE empty/unset&#39;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">category</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing_categories</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">BadHomepage</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;HOMEPAGE should be undefined for </span><span class="si">{</span><span class="n">pkg</span><span class="o">.</span><span class="n">category</span><span class="si">!r}</span><span class="s1"> packages&#39;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">homepage</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">homepage</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">homepage</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_sites</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">BadHomepage</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unspecific HOMEPAGE: </span><span class="si">{</span><span class="n">homepage</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">homepage</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;://&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">BadHomepage</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;HOMEPAGE=</span><span class="si">{</span><span class="n">homepage</span><span class="si">!r}</span><span class="s1"> lacks protocol&#39;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">homepage</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SrcUriCheck</span><span class="o">.</span><span class="n">valid_protos</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">BadHomepage</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s1">&#39;HOMEPAGE=</span><span class="si">{</span><span class="n">homepage</span><span class="si">!r}</span><span class="s1"> uses unsupported &#39;</span>
                                <span class="sa">f</span><span class="s1">&#39;protocol </span><span class="si">{</span><span class="n">homepage</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="UnknownRestrict"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.UnknownRestrict">[docs]</a><span class="k">class</span> <span class="nc">UnknownRestrict</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package&#39;s RESTRICT metadata has unknown entries.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restricts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restricts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">restricts</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">restricts</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restricts</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;unknown RESTRICT=&quot;</span><span class="si">{</span><span class="n">restricts</span><span class="si">}</span><span class="s1">&quot;&#39;</span></div>


<div class="viewcode-block" id="UnknownProperties"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.UnknownProperties">[docs]</a><span class="k">class</span> <span class="nc">UnknownProperties</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package&#39;s PROPERTIES metadata has unknown entries.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;unknown PROPERTIES=&quot;</span><span class="si">{</span><span class="n">properties</span><span class="si">}</span><span class="s1">&quot;&#39;</span></div>


<div class="viewcode-block" id="InvalidRestrict"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.InvalidRestrict">[docs]</a><span class="k">class</span> <span class="nc">InvalidRestrict</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package&#39;s RESTRICT is invalid.&quot;&quot;&quot;</span>

    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;restrict&#39;</span></div>


<div class="viewcode-block" id="InvalidProperties"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.InvalidProperties">[docs]</a><span class="k">class</span> <span class="nc">InvalidProperties</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Package&#39;s PROPERTIES is invalid.&quot;&quot;&quot;</span>

    <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;properties&#39;</span></div>


<span class="k">class</span> <span class="nc">_RestrictPropertiesCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generic check for RESTRICT and PROPERTIES.&quot;&quot;&quot;</span>

    <span class="n">_attr</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_unknown_result_cls</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">required_addons</span> <span class="o">=</span> <span class="p">(</span><span class="n">addons</span><span class="o">.</span><span class="n">UseAddon</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">use_addon</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="n">use_addon</span><span class="o">.</span><span class="n">get_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attr</span><span class="p">)</span>

        <span class="c1"># pull allowed values from a repo and its masters</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">repo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">target_repo</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span>
            <span class="n">allowed</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_attr</span><span class="si">}</span><span class="s1">_allowed&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowed</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">allowed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="n">values</span><span class="p">,</span> <span class="n">unstated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="nb">str</span><span class="p">,),</span> <span class="n">pkg</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr</span><span class="p">))</span>
        <span class="k">yield from</span> <span class="n">unstated</span>

        <span class="c1"># skip if target repo or its masters don&#39;t define allowed values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed</span> <span class="ow">and</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">unknown</span> <span class="o">:=</span> <span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed</span><span class="p">):</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unknown_result_cls</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unknown</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span>


<div class="viewcode-block" id="RestrictCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.RestrictCheck">[docs]</a><span class="k">class</span> <span class="nc">RestrictCheck</span><span class="p">(</span><span class="n">_RestrictPropertiesCheck</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;RESTRICT related checks.&quot;&quot;&quot;</span>

    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">UnknownRestrict</span><span class="p">,</span> <span class="n">UnstatedIuse</span><span class="p">,</span> <span class="n">InvalidRestrict</span><span class="p">])</span>
    <span class="n">_attr</span> <span class="o">=</span> <span class="s1">&#39;restrict&#39;</span>
    <span class="n">_unknown_result_cls</span> <span class="o">=</span> <span class="n">UnknownRestrict</span></div>


<div class="viewcode-block" id="PropertiesCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.PropertiesCheck">[docs]</a><span class="k">class</span> <span class="nc">PropertiesCheck</span><span class="p">(</span><span class="n">_RestrictPropertiesCheck</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;PROPERTIES related checks.&quot;&quot;&quot;</span>

    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">UnknownProperties</span><span class="p">,</span> <span class="n">UnstatedIuse</span><span class="p">,</span> <span class="n">InvalidProperties</span><span class="p">])</span>
    <span class="n">_attr</span> <span class="o">=</span> <span class="s1">&#39;properties&#39;</span>
    <span class="n">_unknown_result_cls</span> <span class="o">=</span> <span class="n">UnknownProperties</span></div>


<div class="viewcode-block" id="MissingTestRestrict"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.MissingTestRestrict">[docs]</a><span class="k">class</span> <span class="nc">MissingTestRestrict</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Missing ``RESTRICT=&quot;!test? ( test )&quot;``.</span>

<span class="sd">    Traditionally, it was assumed that ``IUSE=test`` is a special flag that is</span>
<span class="sd">    implicitly enabled when running ``src_test()`` is enabled. However, this is</span>
<span class="sd">    not standarized and packages need to explicitly specify</span>
<span class="sd">    ``RESTRICT=&quot;!test? ( test )&quot;`` in order to guarantee that test phase will</span>
<span class="sd">    be skipped when the flag is disabled and therefore test dependencies may</span>
<span class="sd">    not be installed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;missing RESTRICT=&quot;!test? ( test )&quot; with IUSE=test&#39;</span></div>


<div class="viewcode-block" id="RestrictTestCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.RestrictTestCheck">[docs]</a><span class="k">class</span> <span class="nc">RestrictTestCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check whether packages specify RESTRICT=&quot;!test? ( test )&quot;.&quot;&quot;&quot;</span>

    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">MissingTestRestrict</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># create &quot;!test? ( test )&quot; conditional to match restrictions against</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_restrict</span> <span class="o">=</span> <span class="n">packages</span><span class="o">.</span><span class="n">Conditional</span><span class="p">(</span>
            <span class="s1">&#39;use&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">.</span><span class="n">ContainmentMatch2</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">negate</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="RestrictTestCheck.feed"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.RestrictTestCheck.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;test&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">iuse</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># conditional is unnecessary if it already exists or is in unconditional form</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pkg</span><span class="o">.</span><span class="n">restrict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_restrict</span><span class="p">):</span>
                <span class="k">return</span>

        <span class="k">yield</span> <span class="n">MissingTestRestrict</span><span class="p">(</span><span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MissingUnpackerDep"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.MissingUnpackerDep">[docs]</a><span class="k">class</span> <span class="nc">MissingUnpackerDep</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">VersionResult</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Missing dependency on a required unpacker package.</span>

<span class="sd">    Package uses an archive format for which an unpacker is not provided by the</span>
<span class="sd">    system set, and lacks an explicit dependency on the unpacker package.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eapi</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">unpackers</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eapi</span> <span class="o">=</span> <span class="n">eapi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpackers</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">unpackers</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># determine proper dep type from pkg EAPI</span>
        <span class="n">eapi_obj</span> <span class="o">=</span> <span class="n">get_eapi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eapi</span><span class="p">)</span>
        <span class="n">dep_type</span> <span class="o">=</span> <span class="s1">&#39;BDEPEND&#39;</span> <span class="k">if</span> <span class="s1">&#39;BDEPEND&#39;</span> <span class="ow">in</span> <span class="n">eapi_obj</span><span class="o">.</span><span class="n">metadata_keys</span> <span class="k">else</span> <span class="s1">&#39;DEPEND&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unpackers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpackers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dep</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;|| ( </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unpackers</span><span class="p">)</span><span class="si">}</span><span class="s2"> )&quot;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">pluralism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;missing </span><span class="si">{</span><span class="n">dep_type</span><span class="si">}</span><span class="s1">=&quot;</span><span class="si">{</span><span class="n">dep</span><span class="si">}</span><span class="s1">&quot; for SRC_URI archive</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">: [ </span><span class="si">{</span><span class="n">filenames</span><span class="si">}</span><span class="s1"> ]&#39;</span></div>


<div class="viewcode-block" id="MissingUnpackerDepCheck"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.MissingUnpackerDepCheck">[docs]</a><span class="k">class</span> <span class="nc">MissingUnpackerDepCheck</span><span class="p">(</span><span class="n">Check</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check whether package is missing unpacker dependencies.&quot;&quot;&quot;</span>

    <span class="n">known_results</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">MissingUnpackerDep</span><span class="p">])</span>
    <span class="n">required_addons</span> <span class="o">=</span> <span class="p">(</span><span class="n">addons</span><span class="o">.</span><span class="n">UseAddon</span><span class="p">,)</span>

    <span class="n">non_system_unpackers</span> <span class="o">=</span> <span class="n">ImmutableDict</span><span class="p">({</span>
        <span class="s1">&#39;.zip&#39;</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s1">&#39;app-arch/unzip&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;.7z&#39;</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s1">&#39;app-arch/p7zip&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;.rar&#39;</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s1">&#39;app-arch/rar&#39;</span><span class="p">,</span> <span class="s1">&#39;app-arch/unrar&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;.lha&#39;</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s1">&#39;app-arch/lha&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;.lzh&#39;</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s1">&#39;app-arch/lha&#39;</span><span class="p">]),</span>
    <span class="p">})</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">use_addon</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dep_filter</span> <span class="o">=</span> <span class="n">use_addon</span><span class="o">.</span><span class="n">get_filter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_filter</span> <span class="o">=</span> <span class="n">use_addon</span><span class="o">.</span><span class="n">get_filter</span><span class="p">(</span><span class="s1">&#39;fetchables&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="MissingUnpackerDepCheck.feed"><a class="viewcode-back" href="../../../api/pkgcheck.checks.metadata.html#pkgcheck.checks.metadata.MissingUnpackerDepCheck.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="c1"># ignore conditionals</span>
        <span class="n">fetchables</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_filter</span><span class="p">(</span>
            <span class="p">(</span><span class="n">fetchable</span><span class="p">,),</span> <span class="n">pkg</span><span class="p">,</span>
            <span class="n">pkg</span><span class="o">.</span><span class="n">generate_fetchables</span><span class="p">(</span>
                <span class="n">allow_missing_checksums</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_unknown_mirrors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">skip_default_mirrors</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="n">missing_unpackers</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

        <span class="c1"># scan for fetchables that require unpackers not in the system set</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fetchables</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_system_unpackers</span><span class="p">:</span>
                <span class="n">missing_unpackers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">non_system_unpackers</span><span class="p">[</span><span class="n">ext</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># toss all the potentially missing unpackers that properly include deps</span>
        <span class="k">if</span> <span class="n">missing_unpackers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dep_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;bdepend&#39;</span><span class="p">,</span> <span class="s1">&#39;depend&#39;</span><span class="p">):</span>
                <span class="n">deps</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dep_filter</span><span class="p">((</span><span class="n">atom_cls</span><span class="p">,),</span> <span class="n">pkg</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">dep_type</span><span class="p">))</span>
                <span class="n">deps</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">unpackers</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">missing_unpackers</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">unpackers</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">deps</span><span class="p">):</span>
                        <span class="n">missing_unpackers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">unpackers</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">unpackers</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">missing_unpackers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">MissingUnpackerDep</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">eapi</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filenames</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unpackers</span><span class="p">),</span> <span class="n">pkg</span><span class="o">=</span><span class="n">pkg</span><span class="p">)</span></div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">pkgcheck master documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../checks.html" >pkgcheck.checks</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pkgcheck.checks.metadata</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2006-2021, pkgcheck contributors.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.1.1.
    </div>
  </body>
</html>